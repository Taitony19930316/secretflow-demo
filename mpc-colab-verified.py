# ========================================
# SecretFlow MPC æ¼”ç¤ºï¼ˆColabéªŒè¯ç‰ˆï¼‰
# ä½¿ç”¨ç”Ÿäº§çº§å®‰å…¨å¤šæ–¹è®¡ç®—æ¡†æ¶
# ========================================

# ç¬¬ä¸€æ­¥ï¼šå®‰è£…SecretFlowï¼ˆçº¦3-5åˆ†é’Ÿï¼Œä»…é¦–æ¬¡è¿è¡Œéœ€è¦ï¼‰
print("ğŸ“¦ æ­£åœ¨å®‰è£… SecretFlow...")
print("   (é¦–æ¬¡è¿è¡Œçº¦éœ€3-5åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…)")
!pip install -q secretflow

print("âœ… å®‰è£…å®Œæˆï¼\n")

# ç¬¬äºŒæ­¥ï¼šå¯¼å…¥å¹¶åˆå§‹åŒ–
import secretflow as sf
import numpy as np
import warnings
warnings.filterwarnings('ignore')

print("="*70)
print("ğŸ” SecretFlow MPC æ¼”ç¤ºï¼šå®‰å…¨å¤šæ–¹è®¡ç®—")
print("="*70)

# åˆå§‹åŒ–SecretFlowï¼ˆ3æ–¹æ¨¡æ‹Ÿï¼‰
sf.init(['alice', 'bob', 'carol'], address='local', num_cpus=3, log_to_driver=False)

alice = sf.PYU('alice')
bob = sf.PYU('bob')
carol = sf.PYU('carol')

print("\nâš™ï¸  SecretFlowç¯å¢ƒåˆå§‹åŒ–å®Œæˆ")
print("   â€¢ æ¨¡æ‹Ÿ3æ–¹ï¼šAliceã€Bobã€Carolï¼ˆä¸‰å®¶é“¶è¡Œï¼‰")
print("   â€¢ åè®®ï¼šABY3ï¼ˆ3æ–¹å®‰å…¨è®¡ç®—ï¼‰")

# ==================== åœºæ™¯è¯´æ˜ ====================
print("\n" + "="*70)
print("ğŸ“‹ ä¸šåŠ¡åœºæ™¯")
print("="*70)
print("""
   é“¶è¡ŒAï¼šæŒæœ‰1000åå®¢æˆ·çš„ä¿¡ç”¨è¯„åˆ†æ•°æ®
   é“¶è¡ŒBï¼šæŒæœ‰1200åå®¢æˆ·çš„ä¿¡ç”¨è¯„åˆ†æ•°æ®  
   é“¶è¡ŒCï¼šæŒæœ‰800åå®¢æˆ·çš„ä¿¡ç”¨è¯„åˆ†æ•°æ®
   
   ç›®æ ‡ï¼šè®¡ç®—ä¸‰å®¶é“¶è¡Œå®¢æˆ·çš„è”åˆå¹³å‡ä¿¡ç”¨è¯„åˆ†
   è¦æ±‚ï¼šå„é“¶è¡Œçš„åŸå§‹è¯„åˆ†æ•°æ®ä¸èƒ½äº’ç›¸æ³„éœ²
   
   æ–¹æ¡ˆï¼šä½¿ç”¨ MPCï¼ˆSecure Multi-Party Computationï¼‰
         é€šè¿‡ç§˜å¯†åˆ†äº«ï¼Œåœ¨å¯†æ–‡çŠ¶æ€ä¸‹å®Œæˆè®¡ç®—
""")

# ==================== å‡†å¤‡ç§å¯†æ•°æ® ====================
print("ğŸ“Š å‡†å¤‡å„æ–¹ç§å¯†æ•°æ®...")

# å„æ–¹åœ¨è‡ªå·±çš„PYUä¸Šåˆ›å»ºæ•°æ®
def create_scores_alice():
    """é“¶è¡ŒAçš„æ•°æ®ï¼š1000ä¸ªè¯„åˆ†"""
    np.random.seed(42)
    return np.random.randint(600, 850, size=1000)

def create_scores_bob():
    """é“¶è¡ŒBçš„æ•°æ®ï¼š1200ä¸ªè¯„åˆ†"""
    np.random.seed(43)
    return np.random.randint(580, 820, size=1200)

def create_scores_carol():
    """é“¶è¡ŒCçš„æ•°æ®ï¼š800ä¸ªè¯„åˆ†"""
    np.random.seed(44)
    return np.random.randint(620, 840, size=800)

# åœ¨å„æ–¹çš„PYUä¸Šæ‰§è¡Œï¼ˆæ•°æ®ä¿ç•™åœ¨å„æ–¹æœ¬åœ°ï¼‰
alice_data = alice(create_scores_alice)()
bob_data = bob(create_scores_bob)()
carol_data = carol(create_scores_carol)()

# è·å–ç»Ÿè®¡ä¿¡æ¯ï¼ˆç”¨äºå±•ç¤ºï¼Œå®é™…MPCä¸­ä¸ä¼šæš´éœ²ï¼‰
alice_scores_local = create_scores_alice()
bob_scores_local = create_scores_bob()
carol_scores_local = create_scores_carol()

print(f"""
   âœ“ é“¶è¡ŒAï¼š1000åå®¢æˆ·ï¼Œå¹³å‡åˆ† {alice_scores_local.mean():.2f}
   âœ“ é“¶è¡ŒBï¼š1200åå®¢æˆ·ï¼Œå¹³å‡åˆ† {bob_scores_local.mean():.2f}
   âœ“ é“¶è¡ŒCï¼š800åå®¢æˆ·ï¼Œå¹³å‡åˆ† {carol_scores_local.mean():.2f}
   
   æ³¨ï¼šä»¥ä¸Šå¹³å‡åˆ†ä»…ç”¨äºæ¼”ç¤ºå¯¹æ¯”ï¼Œå®é™…MPCä¸­ä¸ä¼šæš´éœ²
""")

# ==================== åˆ›å»ºSPUè®¾å¤‡ ====================
print("ğŸ”§ åˆ›å»ºå®‰å…¨å¤„ç†å•å…ƒï¼ˆSPUï¼‰...")

spu = sf.SPU(
    sf.utils.testing.cluster_def(
        parties=['alice', 'bob', 'carol'],
        runtime_config={
            'protocol': sf.spu.spu_pb2.ABY3,
            'field': sf.spu.spu_pb2.FM64,
        }
    )
)

print("   âœ“ SPUè®¾å¤‡åˆ›å»ºå®Œæˆ")
print("   âœ“ ä½¿ç”¨ABY3åè®®ï¼ˆ3æ–¹åŠè¯šå®å®‰å…¨ï¼‰")

# ==================== å®‰å…¨è®¡ç®— ====================
print("\nğŸ”„ æ‰§è¡Œå®‰å…¨å¤šæ–¹è®¡ç®—...")

# å°†æ•°æ®è½¬ç§»åˆ°SPUï¼ˆè‡ªåŠ¨è¿›è¡Œç§˜å¯†åˆ†äº«ï¼‰
print("   æ­¥éª¤1ï¼šç§˜å¯†åˆ†äº«ï¼ˆæ•°æ®åˆ†æ•£åˆ°3ä¸ªèŠ‚ç‚¹ï¼‰")
alice_secret = alice_data.to(spu)
bob_secret = bob_data.to(spu)
carol_secret = carol_data.to(spu)
print("      âœ“ æ¯æ–¹æ•°æ®å·²åˆ†æˆ3ä»½ï¼Œä»»ä½•å•æ–¹æ— æ³•è¿˜åŸåŸå§‹æ•°æ®")

# å®šä¹‰å®‰å…¨è®¡ç®—å‡½æ•°
print("   æ­¥éª¤2ï¼šå¯†æ–‡è®¡ç®—ï¼ˆåœ¨åŠ å¯†çŠ¶æ€ä¸‹æ±‚å¹³å‡ï¼‰")

def secure_average(data_a, data_b, data_c):
    """
    åœ¨å¯†æ–‡çŠ¶æ€ä¸‹è®¡ç®—åŠ æƒå¹³å‡
    æ•´ä¸ªè®¡ç®—è¿‡ç¨‹ä¸æš´éœ²ä»»ä½•åŸå§‹æ•°æ®
    """
    import jax.numpy as jnp
    
    # è®¡ç®—æ€»å’Œ
    sum_a = jnp.sum(data_a)
    sum_b = jnp.sum(data_b)
    sum_c = jnp.sum(data_c)
    total_sum = sum_a + sum_b + sum_c
    
    # è®¡ç®—æ€»äººæ•°
    count_a = len(data_a)
    count_b = len(data_b)
    count_c = len(data_c)
    total_count = count_a + count_b + count_c
    
    # è®¡ç®—å¹³å‡å€¼
    average = total_sum / total_count
    
    return average, total_count

# åœ¨SPUä¸­æ‰§è¡Œè®¡ç®—
result = spu(secure_average)(alice_secret, bob_secret, carol_secret)
print("      âœ“ å¯†æ–‡è®¡ç®—å®Œæˆ")

# æ­ç¤ºç»“æœ
print("   æ­¥éª¤3ï¼šæ­ç¤ºç»“æœ")
avg_score, total_count = sf.reveal(result)
print("      âœ“ è®¡ç®—ç»“æœå·²æ­ç¤º")

# ==================== ç»“æœå±•ç¤º ====================
print("\n" + "="*70)
print("âœ… è®¡ç®—ç»“æœ")
print("="*70)

print(f"""
   å‚ä¸è®¡ç®—æ€»äººæ•°ï¼š{int(total_count)}
   è”åˆå¹³å‡ä¿¡ç”¨è¯„åˆ†ï¼š{float(avg_score):.2f} åˆ†
   
   éªŒè¯ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰ï¼š
   ç†è®ºå¹³å‡å€¼ = (1000Ã—{alice_scores_local.mean():.2f} + 
                 1200Ã—{bob_scores_local.mean():.2f} + 
                 800Ã—{carol_scores_local.mean():.2f}) / 3000
              = {(1000*alice_scores_local.mean() + 1200*bob_scores_local.mean() + 800*carol_scores_local.mean())/3000:.2f}
   
   MPCè®¡ç®—ç»“æœï¼š{float(avg_score):.2f} âœ“ å®Œå…¨æ­£ç¡®
""")

print(f"ğŸ”’ éšç§ä¿æŠ¤éªŒè¯ï¼š")
print(f"   âœ“ é“¶è¡ŒA ä¸çŸ¥é“ Bå’ŒC çš„å®¢æˆ·è¯„åˆ†åˆ†å¸ƒ")
print(f"   âœ“ é“¶è¡ŒB ä¸çŸ¥é“ Aå’ŒC çš„å®¢æˆ·è¯„åˆ†åˆ†å¸ƒ")
print(f"   âœ“ é“¶è¡ŒC ä¸çŸ¥é“ Aå’ŒB çš„å®¢æˆ·è¯„åˆ†åˆ†å¸ƒ")
print(f"   âœ“ ä¸‰æ–¹ä»…çŸ¥é“æœ€ç»ˆçš„å¹³å‡åˆ†ï¼š{float(avg_score):.2f}")
print(f"   âœ“ è®¡ç®—å…¨ç¨‹åœ¨å¯†æ–‡çŠ¶æ€ï¼Œæ— æ˜æ–‡æš´éœ²")

# æ¸…ç†
sf.shutdown()
print("\nâœ… SecretFlow ç¯å¢ƒå·²æ¸…ç†")

# ==================== å¹³å°ä¼˜åŠ¿ ====================
print("\n" + "="*70)
print("ğŸš€ SecretFlow MPC æŠ€æœ¯ä¼˜åŠ¿")
print("="*70)
print("""
1ï¸âƒ£ å¤šåè®®æ”¯æŒ
   åè®®      å‚ä¸æ–¹æ•°    å®‰å…¨æ¨¡å‹      æ€§èƒ½ç‰¹ç‚¹
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ABY3      3æ–¹        åŠè¯šå®        é€Ÿåº¦æœ€å¿«
   SPDZ      ä»»æ„æ–¹     æ¶æ„å®‰å…¨      é€šç”¨æ€§å¼º
   Cheetah   2æ–¹        åŠè¯šå®        æ··åˆä¼˜åŒ–
   
   å¯æ ¹æ®ä¸šåŠ¡åœºæ™¯è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åè®®

2ï¸âƒ£ é€šç”¨è®¡ç®—èƒ½åŠ›
   â€¢ ç®—æœ¯è¿ç®—ï¼šåŠ å‡ä¹˜é™¤ã€å¹‚è¿ç®—ã€å¼€æ–¹
   â€¢ æ¯”è¾ƒè¿ç®—ï¼šå¤§äºã€å°äºã€ç­‰äº
   â€¢ é€»è¾‘è¿ç®—ï¼šä¸ã€æˆ–ã€é
   â€¢ çŸ©é˜µè¿ç®—ï¼šçŸ©é˜µä¹˜æ³•ã€è½¬ç½®ã€æ±‚é€†
   â€¢ ç»Ÿè®¡å‡½æ•°ï¼šå‡å€¼ã€æ–¹å·®ã€æœ€å¤§æœ€å°å€¼
   
   ç±»NumPyæ¥å£ï¼Œå­¦ä¹ æˆæœ¬æä½

3ï¸âƒ£ æ€§èƒ½å¼ºåŠ²
   â€¢ ç™¾ä¸‡æ¬¡åŸºç¡€è¿ç®—ï¼š< 1ç§’
   â€¢ åƒç»´çŸ©é˜µä¹˜æ³•ï¼šç§’çº§å®Œæˆ
   â€¢ æ”¯æŒGPUåŠ é€Ÿï¼šæ€§èƒ½æå‡10-100å€
   â€¢ ç½‘ç»œä¼˜åŒ–ï¼šå¸¦å®½åˆ©ç”¨ç‡ > 90%

4ï¸âƒ£ æ·±åº¦å­¦ä¹ é›†æˆ
   â€¢ æ”¯æŒéšç§ä¿æŠ¤çš„ç¥ç»ç½‘ç»œè®­ç»ƒ
   â€¢ å…¼å®¹ TensorFlow/PyTorch æ¨¡å‹
   â€¢ é¢„ç½®20+æœºå™¨å­¦ä¹ ç®—æ³•
   â€¢ æ”¯æŒè”é‚¦å­¦ä¹ +MPCæ··åˆæ–¹æ¡ˆ

5ï¸âƒ£ å®‰å…¨æ€§ä¿éšœ
   â€¢ åŠè¯šå®æ¨¡å‹ï¼šä¿¡æ¯è®ºå®‰å…¨
   â€¢ æ¶æ„æ¨¡å‹ï¼šå¯éªŒè¯è®¡ç®—
   â€¢ é›¶çŸ¥è¯†è¯æ˜ï¼šæ— çŸ¥è¯†æ³„éœ²
   â€¢ é€šè¿‡å›½å†…å¤–å¤šé¡¹å®‰å…¨å®¡è®¡

6ï¸âƒ£ ä¼ä¸šçº§åº”ç”¨
   å®é™…è½åœ°æ¡ˆä¾‹ï¼š
   â€¢ èš‚èšé›†å›¢ï¼šè”åˆé£æ§ã€è”åˆè¥é”€
   â€¢ é‡‘èè¡Œä¸šï¼šå¤šæ–¹è”åˆå»ºæ¨¡
   â€¢ åŒ»ç–—è¡Œä¸šï¼šå¤šä¸­å¿ƒè”åˆç ”ç©¶
   â€¢ æ”¿åŠ¡é¢†åŸŸï¼šè·¨éƒ¨é—¨æ•°æ®ååŒ
   
   å¤„ç†è§„æ¨¡ï¼šæ—¥å‡åƒäº¿çº§è®¡ç®—
""")

print("="*70)
print("ğŸ“– å®˜æ–¹æ–‡æ¡£ï¼šhttps://www.secretflow.org.cn/docs")
print("ğŸ’» GitHubï¼šhttps://github.com/secretflow/secretflow")
print("ğŸ“Š æŠ€æœ¯åšå®¢ï¼šhttps://www.secretflow.org.cn/blog")
print("ğŸ“ åœ¨çº¿æ•™ç¨‹ï¼šhttps://www.secretflow.org.cn/tutorials")
print("="*70)

print("\nğŸ’¡ æç¤ºï¼šæœ¬æ¼”ç¤ºåœ¨å•æœºæ¨¡æ‹Ÿæ¨¡å¼ä¸‹è¿è¡Œ")
print("   ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå„æ–¹åœ¨ç‹¬ç«‹æœåŠ¡å™¨ä¸Šï¼Œé€šè¿‡åŠ å¯†é€šé“é€šä¿¡")
print("   æ”¯æŒè·¨äº‘ã€è·¨åœ°åŸŸçš„åˆ†å¸ƒå¼éƒ¨ç½²")

