# ========================================
# SecretFlow MPC æ¼”ç¤º
# ä½¿ç”¨ç”Ÿäº§çº§å®‰å…¨å¤šæ–¹è®¡ç®—æ¡†æ¶
# ========================================

# å®‰è£…SecretFlowï¼ˆé¦–æ¬¡è¿è¡Œçº¦éœ€3åˆ†é’Ÿï¼‰
!pip install -U secretflow

# å¯¼å…¥åº“
import secretflow as sf
import numpy as np

# åˆå§‹åŒ–SecretFlowé›†ç¾¤ï¼ˆ3æ–¹å‚ä¸ï¼‰
sf.init(['alice', 'bob', 'charlie'], address='local', num_cpus=8, log_to_driver=False)

alice, bob, charlie = sf.PYU('alice'), sf.PYU('bob'), sf.PYU('charlie')

print("="*70)
print("ğŸ” SecretFlow MPC æ¼”ç¤ºï¼šå®‰å…¨å¤šæ–¹è®¡ç®—")
print("="*70)

# ==================== åœºæ™¯è¯´æ˜ ====================
print("\nğŸ“‹ ä¸šåŠ¡åœºæ™¯ï¼š")
print("   ä¸‰å®¶é“¶è¡Œæƒ³è®¡ç®—å®¢æˆ·çš„å¹³å‡ä¿¡ç”¨è¯„åˆ†")
print("   é“¶è¡ŒAï¼šæŒæœ‰1000åå®¢æˆ·æ•°æ®")
print("   é“¶è¡ŒBï¼šæŒæœ‰1200åå®¢æˆ·æ•°æ®")
print("   é“¶è¡ŒCï¼šæŒæœ‰800åå®¢æˆ·æ•°æ®")
print("   ç›®æ ‡ï¼šè®¡ç®—è”åˆå¹³å‡åˆ†ï¼Œä½†å„è¡Œæ•°æ®ä¸èƒ½äº’ç›¸æ³„éœ²")

# ==================== åˆ›å»ºSPUè®¾å¤‡ ====================
print("\nâš™ï¸  åˆå§‹åŒ–å®‰å…¨å¤„ç†å•å…ƒï¼ˆSPUï¼‰...")
print("   åè®®ï¼šABY3ï¼ˆ3æ–¹å®‰å…¨è®¡ç®—åè®®ï¼‰")

# é…ç½®SPU
spu = sf.SPU(sf.utils.testing.cluster_def(['alice', 'bob', 'charlie']))

# ==================== å‡†å¤‡ç§å¯†æ•°æ® ====================
print("\nğŸ“Š å‡†å¤‡å„æ–¹æ•°æ®...")

# å„é“¶è¡Œçš„ç§å¯†æ•°æ®ï¼ˆä¿¡ç”¨è¯„åˆ†ï¼‰
def create_alice_data():
    return np.random.randint(600, 850, size=1000)  # 1000ä¸ªè¯„åˆ†

def create_bob_data():
    return np.random.randint(580, 820, size=1200)  # 1200ä¸ªè¯„åˆ†

def create_charlie_data():
    return np.random.randint(620, 840, size=800)   # 800ä¸ªè¯„åˆ†

# åœ¨å„æ–¹PYUä¸Šåˆ›å»ºæ•°æ®
alice_scores = alice(create_alice_data)()
bob_scores = bob(create_bob_data)()
charlie_scores = charlie(create_charlie_data)()

print(f"   âœ“ é“¶è¡ŒAï¼š1000åå®¢æˆ·è¯„åˆ†ï¼ˆå‡å€¼ä¿å¯†ï¼‰")
print(f"   âœ“ é“¶è¡ŒBï¼š1200åå®¢æˆ·è¯„åˆ†ï¼ˆå‡å€¼ä¿å¯†ï¼‰")
print(f"   âœ“ é“¶è¡ŒCï¼š800åå®¢æˆ·è¯„åˆ†ï¼ˆå‡å€¼ä¿å¯†ï¼‰")

# ==================== å®‰å…¨è®¡ç®— ====================
print("\nğŸ”„ æ‰§è¡Œå®‰å…¨å¤šæ–¹è®¡ç®—ï¼ˆMPCï¼‰...")
print("   è®¡ç®—ï¼šåŠ æƒå¹³å‡ä¿¡ç”¨è¯„åˆ†")

# å°†æ•°æ®è½¬ç§»åˆ°SPUï¼ˆç§˜å¯†åˆ†äº«ï¼‰
alice_secret = alice_scores.to(spu)
bob_secret = bob_scores.to(spu)
charlie_secret = charlie_scores.to(spu)

print("   âœ“ æ•°æ®å·²è¿›è¡Œç§˜å¯†åˆ†äº«ï¼ˆæ¯æ–¹æ•°æ®åˆ†æ•£åˆ°3ä¸ªèŠ‚ç‚¹ï¼‰")

# åœ¨SPUä¸­æ‰§è¡Œå®‰å…¨è®¡ç®—
@sf.device('spu')
def secure_weighted_average(scores_a, scores_b, scores_c):
    """
    å®‰å…¨è®¡ç®—åŠ æƒå¹³å‡åˆ†
    å…¨ç¨‹åœ¨å¯†æ–‡çŠ¶æ€ä¸‹è®¡ç®—ï¼ŒåŸå§‹æ•°æ®ä¸æ³„éœ²
    """
    # è®¡ç®—å„æ–¹æ€»åˆ†
    sum_a = scores_a.sum()
    sum_b = scores_b.sum()
    sum_c = scores_c.sum()
    
    # è®¡ç®—å„æ–¹äººæ•°
    count_a = len(scores_a)
    count_b = len(scores_b)
    count_c = len(scores_c)
    
    # åŠ æƒå¹³å‡
    total_sum = sum_a + sum_b + sum_c
    total_count = count_a + count_b + count_c
    avg_score = total_sum / total_count
    
    return avg_score, total_count

# æ‰§è¡Œå®‰å…¨è®¡ç®—
result_secret = spu(secure_weighted_average)(alice_secret, bob_secret, charlie_secret)

print("   âœ“ å¯†æ–‡è®¡ç®—å®Œæˆ")

# æ­ç¤ºç»“æœ
avg_score, total_count = sf.reveal(result_secret)

print("   âœ“ ç»“æœå·²æ­ç¤º")

# ==================== ç»“æœå±•ç¤º ====================
print("\n" + "="*70)
print("âœ… è®¡ç®—ç»“æœ")
print("="*70)
print(f"   å‚ä¸è®¡ç®—æ€»äººæ•°ï¼š{total_count}")
print(f"   è”åˆå¹³å‡ä¿¡ç”¨è¯„åˆ†ï¼š{avg_score:.2f}")

print(f"\nğŸ”’ éšç§ä¿æŠ¤ï¼š")
print(f"   âœ“ é“¶è¡ŒAä¸çŸ¥é“Bã€Cçš„å®¢æˆ·è¯„åˆ†åˆ†å¸ƒ")
print(f"   âœ“ é“¶è¡ŒBä¸çŸ¥é“Aã€Cçš„å®¢æˆ·è¯„åˆ†åˆ†å¸ƒ")
print(f"   âœ“ é“¶è¡ŒCä¸çŸ¥é“Aã€Bçš„å®¢æˆ·è¯„åˆ†åˆ†å¸ƒ")
print(f"   âœ“ ä¸‰æ–¹ä»…çŸ¥é“æœ€ç»ˆçš„å¹³å‡åˆ†")
print(f"   âœ“ è®¡ç®—å…¨ç¨‹åœ¨å¯†æ–‡çŠ¶æ€ä¸‹è¿›è¡Œï¼Œæ— æ˜æ–‡æš´éœ²")

# æ¸…ç†
sf.shutdown()

# ==================== SecretFlow å¹³å°ä¼˜åŠ¿ ====================
print("\n" + "="*70)
print("ğŸš€ SecretFlow MPC å¹³å°ä¼˜åŠ¿")
print("="*70)

print("""
1ï¸âƒ£ åè®®ä¸°å¯Œ
   â€¢ ABY3ï¼š3æ–¹åŠè¯šå®æ¨¡å‹ï¼Œæ€§èƒ½æœ€ä¼˜
   â€¢ SPDZï¼šæ”¯æŒä»»æ„æ–¹æ•°ï¼Œé˜²æ¶æ„æ”»å‡»
   â€¢ Cheetahï¼š2æ–¹åŠè¯šå®ï¼Œæ··åˆåè®®ä¼˜åŒ–
   â€¢ è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜åè®®ç»„åˆ

2ï¸âƒ£ é€šç”¨è®¡ç®—èƒ½åŠ›
   â€¢ æ”¯æŒåŠ å‡ä¹˜é™¤ç­‰ç®—æœ¯è¿ç®—
   â€¢ æ”¯æŒæ¯”è¾ƒã€é€»è¾‘è¿ç®—
   â€¢ æ”¯æŒçŸ©é˜µè¿ç®—ï¼ˆç”¨äºæœºå™¨å­¦ä¹ ï¼‰
   â€¢ ç±»NumPy APIï¼Œé›¶å­¦ä¹ æˆæœ¬

3ï¸âƒ£ æ€§èƒ½å¼ºåŠ²
   â€¢ ç™¾ä¸‡æ¬¡è¿ç®—ç§’çº§å®Œæˆ
   â€¢ GPUåŠ é€Ÿæ”¯æŒ
   â€¢ ç½‘ç»œé€šä¿¡ä¼˜åŒ–ï¼Œå¸¦å®½åˆ©ç”¨ç‡é«˜
   â€¢ äº¿çº§å‚æ•°æ¨¡å‹è®­ç»ƒå®æµ‹éªŒè¯

4ï¸âƒ£ å®‰å…¨æ€§ä¿éšœ
   â€¢ ä¿¡æ¯è®ºå®‰å…¨ï¼ˆåŠè¯šå®æ¨¡å‹ï¼‰
   â€¢ å¯éªŒè¯è®¡ç®—ï¼ˆæ¶æ„æ¨¡å‹ï¼‰
   â€¢ é›¶çŸ¥è¯†è¯æ˜é›†æˆ
   â€¢ é€šè¿‡å¤šé¡¹å®‰å…¨å®¡è®¡

5ï¸âƒ£ ä¸æœºå™¨å­¦ä¹ æ·±åº¦èåˆ
   â€¢ è”é‚¦å­¦ä¹  + MPCæ··åˆæ–¹æ¡ˆ
   â€¢ æ”¯æŒç¥ç»ç½‘ç»œæ¨ç†/è®­ç»ƒ
   â€¢ é¢„ç½®20+éšç§ä¿æŠ¤ç®—æ³•
   â€¢ æ”¯æŒPyTorch/TensorFlowæ¨¡å‹

6ï¸âƒ£ ä¼ä¸šçº§ç‰¹æ€§
   â€¢ èš‚èšé›†å›¢åƒäº¿çº§ä¸šåŠ¡éªŒè¯
   â€¢ é‡‘èé£æ§ã€è”åˆè¥é”€ç­‰å®é™…è½åœ°
   â€¢ å®Œæ•´çš„ç›‘æ§ã€æ—¥å¿—ã€å®¡è®¡èƒ½åŠ›
   â€¢ 7x24æŠ€æœ¯æ”¯æŒ
""")

print("="*70)
print("ğŸ“– æ›´å¤šä¿¡æ¯ï¼šhttps://www.secretflow.org.cn")
print("ğŸ’¡ GitHubï¼šhttps://github.com/secretflow/secretflow")
print("="*70)

